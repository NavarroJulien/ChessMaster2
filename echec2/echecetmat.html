<!DOCTYPE html>
<html lang="fr">
<head>
<script>
/* Si mobile ‚Üí redirection */
if (/Mobi|Android|iPhone|iPad/i.test(navigator.userAgent)) {
    window.location.href = "echecetmat_mobile.html";
}
</script>

<meta charset="UTF-8"/>
<title>CHEAT CHESS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

<style>
    body { font-family: Arial, sans-serif; background:#f5f5f5; padding:20px; }
    #board { 
        width: 480px; 
        height: 480px; 
        display: grid; 
        grid-template-columns: repeat(8, 1fr);
        grid-template-rows: repeat(8, 1fr);
        border: 2px solid #333;
        margin-bottom: 20px;
    }

    .case {
        position: relative;
        width: 60px;
        height: 60px;
        display:flex;
        align-items:center;
        justify-content:center;
        cursor: pointer;
    }
    .clair { background: #f0d9b5; }
    .fonce { background: #b58863; }

    .case.selected {
        outline: 3px solid red;
        box-sizing: border-box;
    }

    .piece {
        width: 50px;
        height: 50px;
        pointer-events: none;
    }

    .coord {
        position: absolute;
        font-size: 15px;
        font-weight: 900;
        color: rgba(255,255,255,0.95);
        text-shadow: 1px 1px 3px #000;
        pointer-events: none;
    }

    .coord-file { bottom: 3px; right: 4px; }
    .coord-rank { top: 3px; left: 4px; }

    button {
        padding: 8px 12px;
        margin-right: 5px;
        cursor:pointer;
    }
	.boardWrap{
  display:flex;
  gap:12px;
  align-items:flex-start;
}

#evalWrap{
  width: 26px;
  height: 480px;
  border: 2px solid #333;
  background: #111;          /* c√¥t√© noir par d√©faut */
  position: relative;
  border-radius: 6px;
  overflow: hidden;
}

#evalWhite{
  position:absolute;
  bottom:0;
  left:0;
  width:100%;
  height:50%;                /* 50% = √©galit√© */
  background:#f5f5f5;        /* c√¥t√© blancs */
  transition: height 180ms ease;
}

#evalLabel{
  position:absolute;
  left: 50%;
  top: 8px;
  transform: translateX(-50%);
  font-weight: 900;
  font-size: 12px;
  padding: 2px 6px;
  border-radius: 10px;
  background: rgba(255,255,255,0.85);
  color:#111;
  user-select:none;
}

</style>
</head>

<body>

<h2>CHEAT</h2>
<p>Clique une pi√®ce ‚Üí clique une destination.</p>

<button id="flipBtn">üîÑ Inverser l'√©chiquier</button>
<button id="undoBtn">‚Ü©Ô∏è Annuler</button>

<div class="boardWrap">
  <div id="board"></div>

  <div id="evalWrap" title="√âvaluation Stockfish (blancs vs noirs)">
    <div id="evalWhite"></div>
    <div id="evalLabel">0.0</div>
  </div>
</div>


<div id="bestMoveWhite">Meilleur coup blancs : (en attente‚Ä¶)</div>
<div id="bestMoveBlack">Meilleur coup noirs : (en attente‚Ä¶)</div>

<script>
// ========= STOCKFISH =========
async function createEngine() {
    const response = await fetch("https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js");
    const text = await response.text();
    const blob = new Blob([text], { type: "application/javascript" });
    return new Worker(URL.createObjectURL(blob));
}

let engine = null;
let engineReady = false;

(async () => {
    engine = await createEngine();
    engine.onmessage = (e) => {
        if (typeof e.data === "string" && e.data.includes("uciok"))
            engineReady = true;
    };
    engine.postMessage("uci");
})();

// ========= VARIABLES =========
let history = [];
let flipped = false;
let selectedSquare = null;

const files = ["a","b","c","d","e","f","g","h"];

const piecesImg = {
    "wK": "chess/wK.png", "wQ": "chess/wQ.png", "wR": "chess/wR.png",
    "wB": "chess/wB.png", "wN": "chess/wN.png", "wP": "chess/wP.png",
    "bK": "chess/bK.png", "bQ": "chess/bQ.png", "bR": "chess/bR.png",
    "bB": "chess/bB.png", "bN": "chess/bN.png", "bP": "chess/bP.png"
};

let position = {
    a8:"bR", b8:"bN", c8:"bB", d8:"bQ", e8:"bK", f8:"bB", g8:"bN", h8:"bR",
    a7:"bP", b7:"bP", c7:"bP", d7:"bP", e7:"bP", f7:"bP", g7:"bP", h7:"bP",
    a2:"wP", b2:"wP", c2:"wP", d2:"wP", e2:"wP", f2:"wP", g2:"wP", h2:"wP",
    a1:"wR", b1:"wN", c1:"wB", d1:"wQ", e1:"wK", f1:"wB", g1:"wN", h1:"wR"
};

// ========= PLATEAU =========
const board = document.getElementById("board");

function renderBoard() {
    board.innerHTML = "";

    let ranks = flipped ? [1,2,3,4,5,6,7,8] : [8,7,6,5,4,3,2,1];
    let fileOrder = flipped ? [...files].reverse() : files;

    for (let r of ranks) {
        for (let f of fileOrder) {

            let id = f + r;
            let fileIndex = files.indexOf(f);

            let div = document.createElement("div");
            div.className = "case " + ((fileIndex + r) % 2 ? "fonce" : "clair");
            div.id = id;
            div.onclick = () => onClickSquare(id);

            if (!flipped && r === 1) {
                let lbl = document.createElement("div");
                lbl.className = "coord coord-file";
                lbl.textContent = f;
                div.appendChild(lbl);
            }

            if (!flipped && fileIndex === 0) {
                let lbl2 = document.createElement("div");
                lbl2.className = "coord coord-rank";
                lbl2.textContent = r;
                div.appendChild(lbl2);
            }

            board.appendChild(div);
        }
    }
}

function refreshBoard() {
    renderBoard();

    for (let sq in position) {
        if (!position[sq]) continue;
        let img = document.createElement("img");
        img.src = piecesImg[position[sq]];
        img.className = "piece";
        let cell = document.getElementById(sq);
        if (cell) cell.appendChild(img);
    }

    // ‚û§ Restaurer la s√©lection visuelle
    if (selectedSquare) {
        let el = document.getElementById(selectedSquare);
        if (el) el.classList.add("selected");
    }
}

renderBoard();
refreshBoard();

// ========= CLIC PIECE =========
function onClickSquare(sq) {
    document.querySelectorAll(".case").forEach(c => c.classList.remove("selected"));

    if (!selectedSquare) {
        if (position[sq]) selectedSquare = sq;
        let el = document.getElementById(sq);
        if (el) el.classList.add("selected");
    } else {
        if (selectedSquare !== sq) makeMove(selectedSquare, sq);
        selectedSquare = null;
    }
}

// ========= MOUVEMENT =========
function makeMove(from, to) {
    if (!position[from]) return;

    history.push(JSON.parse(JSON.stringify(position)));

    const piece = position[from];

    const pieceName = {
        "P": "Pion", "N": "Cavalier", "B": "Fou",
        "R": "Tour", "Q": "Reine", "K": "Roi"
    }[piece[1]];

    position[to] = piece;
    delete position[from];

    if (piece === "wP" && to[1] === "8") position[to] = "wQ";
    if (piece === "bP" && to[1] === "1") position[to] = "bQ";
	
	// Nettoyer la s√©lection apr√®s un d√©placement
	document.querySelectorAll(".case.selected")
		.forEach(c => c.classList.remove("selected"));
	selectedSquare = null;


    refreshBoard();
    analyse();

    console.log("Tu as jou√© :", from + to, "(" + pieceName + ")");
}

// ========= FEN =========
function toFEN(trait="w") {
    let fen = "";
    for (let r = 8; r >= 1; r--) {
        let empty = 0;
        for (let f = 0; f < 8; f++) {
            let sq = files[f] + r;
            if (!position[sq]) empty++;
            else {
                if (empty) { fen += empty; empty = 0; }
                let p = position[sq];
                fen += p[0] === "w" ? p[1].toUpperCase() : p[1].toLowerCase();
            }
        }
        if (empty) fen += empty;
        if (r > 1) fen += "/";
    }
    return fen + " " + trait + " KQkq - 0 1";
}

// ========= ANALYSE =========
function analyse() {
  if (!engineReady) return;

  engine.postMessage("stop");
  engine.postMessage("position fen " + toFEN("w"));
  engine.postMessage("go depth 12");

  engine.onmessage = (e) => {
    const line = e.data;

    // 1) Mettre √† jour la barre √† partir des lignes "info ... score ..."
    if (typeof line === "string" && line.startsWith("info")) {
      const sc = parseScoreFromInfoLine(line);
      if (sc) {
        if (sc.type === "cp") setEvalBarFromCp(sc.value);
        if (sc.type === "mate") setEvalBarMate(sc.value);
      }
      return; // on ne sort pas de l'analyse, on continue √† √©couter
    }

    // 2) Afficher le bestmove quand il arrive
    if (!line.includes("bestmove")) return;

    let best = line.split(" ")[1];
    let sqFrom = best.substring(0,2);
    let pieceChar = position[sqFrom]?.[1] || "P";

    const pieceName = {
      "P": "Pion", "N": "Cavalier", "B": "Fou",
      "R": "Tour", "Q": "Reine", "K": "Roi"
    }[pieceChar];

    document.getElementById("bestMoveWhite").textContent =
      "Meilleur coup blancs : " + best + " (" + pieceName + ")";

    analyseBlack();
  };
}


function clamp(x, a, b){ return Math.max(a, Math.min(b, x)); }

// Convertit un avantage en centipawns (cp) vers une hauteur blanche 0..100%
// On "sature" volontairement √† ¬±600cp pour √©viter une barre trop sensible.
function cpToWhitePercent(cp){
  const capped = clamp(cp, -600, 600);
  // -600 -> 0%, 0 -> 50%, +600 -> 100%
  return 50 + (capped / 600) * 50;
}

function setEvalBarFromCp(cp){
  const pct = clamp(cpToWhitePercent(cp), 0, 100);
  document.getElementById("evalWhite").style.height = pct + "%";

  const label = (cp >= 0 ? "+" : "") + (cp/100).toFixed(1);
  document.getElementById("evalLabel").textContent = label;
}

function setEvalBarMate(mate){
  // mate > 0 => mate pour les blancs, mate < 0 => mate pour les noirs
  // on force visuellement proche du max
  const pct = mate > 0 ? 98 : 2;
  document.getElementById("evalWhite").style.height = pct + "%";
  document.getElementById("evalLabel").textContent = (mate > 0 ? "M" + mate : "M" + mate);
}

// Parse une ligne UCI "info ... score cp 34 ..." ou "info ... score mate 3 ..."
function parseScoreFromInfoLine(line){
  if (!line.includes(" score ")) return null;

  // Exemple: "info depth 12 ... score cp 34 ..."
  // ou:      "info depth 18 ... score mate -2 ..."
  const mCp = line.match(/score\s+cp\s+(-?\d+)/);
  if (mCp) return { type: "cp", value: parseInt(mCp[1], 10) };

  const mMate = line.match(/score\s+mate\s+(-?\d+)/);
  if (mMate) return { type: "mate", value: parseInt(mMate[1], 10) };

  return null;
}

function analyseBlack() {
    engine.postMessage("stop");
    engine.postMessage("position fen " + toFEN("b"));
    engine.postMessage("go depth 12");

    engine.onmessage = (e) => {
        let line = e.data;
        if (!line.includes("bestmove")) return;

        let best = line.split(" ")[1];
        let sqFrom = best.substring(0,2);
        let pieceChar = position[sqFrom]?.[1] || "P";

        const pieceName = {
            "P": "Pion", "N": "Cavalier", "B": "Fou",
            "R": "Tour", "Q": "Reine", "K": "Roi"
        }[pieceChar];

        document.getElementById("bestMoveBlack").textContent =
            "Meilleur coup noirs : " + best + " (" + pieceName + ")";
    };
}

// ========= UNDO =========
document.getElementById("undoBtn").onclick = () => {
    if (history.length === 0) return;
    position = history.pop();
    refreshBoard();
    analyse();
};

// ========= FLIP =========
document.getElementById("flipBtn").onclick = () => {
    flipped = !flipped;
    refreshBoard();
};

</script>

</body>
</html>
